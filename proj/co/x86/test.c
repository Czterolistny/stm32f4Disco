#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <stdint.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdio_ext.h>
#include <termios.h>
#include <pthread.h>
#include <time.h>

#define TC_AFTER_EVERY_BYTE 1

const uint8_t tab1[] = {0x02, 0x26, 0xff, 0xf4, 0x16, 0xf9, 0x00, 0x01, 0x16, 0xc2, 0x00, 0x00, 0x16, 0xf9, 0x00, 0x00,
						0x16, 0xf9, 0x00, 0x02, 0x16, 0xc2, 0x00, 0x00, 0x16, 0xf9, 0x00, 0x00, 0x02, 0x18, 0x2c, 0x11};

const uint8_t tab2[] = {0x02, 0x26, 0xff, 0xf4, 0x16, 0x10, 0x00, 0x00, 0x16, 0x9e, 0x50, 0x2d, 0x15, 0xa7, 0x00, 0x1a,
						0x16, 0xff, 0x00, 0x03, 0x16, 0x9f, 0x3c, 0x1e, 0x15, 0x7c, 0x00, 0x02, 0x15, 0x7d, 0x02, 0x58,
						0x15, 0x7e, 0x00, 0x3c, 0x16, 0x6e, 0x00, 0xd2, 0x16, 0x16, 0x00, 0x1e, 0x16, 0x81, 0xf8, 0x30,
						0x15, 0xcd, 0x00, 0x00, 0x15, 0x89, 0x00, 0x01, 0x15, 0x8b, 0x00, 0x00, 0x15, 0x9b, 0x00, 0x2e,
						0x15, 0xb7, 0x05, 0x46, 0x01, 0xf6, 0x00, 0x00, 0x02, 0x8e, 0x00, 0x00, 0x02, 0x45, 0x00, 0x00,
						0x02, 0x18, 0xf3, 0x3d};

const uint8_t tab3[] = {0x02, 0x26, 0xff, 0xf4, 0x16, 0x10, 0x00, 0x00, 0x16, 0x9e, 0x50, 0x2d, 0x15, 0xa7, 0x00, 0x1a,
						0x16, 0xff, 0x00, 0x03, 0x16, 0x9f, 0x3c, 0x1e, 0x15, 0x7c, 0x00, 0x02, 0x15, 0x7d, 0x02, 0x58,
						0x15, 0x7e, 0x00, 0x3c, 0x16, 0x6e, 0x00, 0xd2, 0x16, 0x16, 0x00, 0x1e, 0x16, 0x81, 0xf8, 0x30,
						0x15, 0xcd, 0x00, 0x00, 0x15, 0x89, 0x00, 0x01, 0x15, 0x8b, 0x00, 0x00, 0x15, 0x9b, 0x00, 0x2d,
						0x15, 0xb7, 0x05, 0x46, 0x01, 0xf6, 0x00, 0x00, 0x02, 0x8e, 0x00, 0x00, 0x02, 0x45, 0x00, 0x00,
						0x02, 0x18, 0xc3, 0x2c};

const uint8_t tab4[] = {0x02, 0x26, 0xff, 0xf4, 0x16, 0x10, 0x00, 0x00, 0x16, 0x9e, 0x50, 0x2d, 0x15, 0xa7, 0x00, 0x1a,
						0x16, 0xff, 0x00, 0x03, 0x16, 0x9f, 0x3c, 0x1e, 0x15, 0x7c, 0x00, 0x02, 0x15, 0x7d, 0x01, 0x72,
						0x15, 0x7e, 0x00, 0x3c, 0x16, 0x6e, 0xf8, 0x30, 0x16, 0x16, 0x00, 0x2d, 0x16, 0x81, 0xf8, 0x30,
						0x15, 0xcd, 0x00, 0x00, 0x15, 0x89, 0x00, 0x01, 0x15, 0x8b, 0x00, 0x00, 0x15, 0x9b, 0x00, 0x64,
						0x15, 0xb7, 0x01, 0x9a, 0x01, 0xf6, 0x00, 0x00, 0x02, 0x8e, 0x00, 0x00, 0x02, 0x45, 0x00, 0x00,
						0x02, 0x18, 0x7b, 0x81};

void *uartRecv(void *v)
{
	int fuart = *((int*) v);

	uint8_t b;
	uint16_t s = 0;
	for(;;){
		ssize_t r = read(fuart, &b, 1);
		if( r < 0 ){
			//perror("read:");
		}else
			printf("%02x ", b); fflush(stdout); s++;
	}
}

int initUart(int fuart)
{

	//fcntl(fuart, F_SETFL, O_ASYNC | fcntl(fuart, F_GETFL));
	struct termios _termios;
	
	if( tcgetattr(fuart, &_termios) < 0 ){
		perror("tcgetattr: ");
		return -1;
	}
    
	//_termios.c_lflag &= ~(ECHO | ICANON | ISIG | IEXTEN);
	//_termios.c_iflag &= ~(BRKINT | ICRNL | INPCK | ISTRIP | IXON);
	//
	//_termios.c_cflag &= ~(CSIZE | PARENB);
	//_termios.c_cflag |= CS8;
	//_termios.c_oflag &= ~OPOST;
	//
	_termios.c_cc[VMIN] = 1;
	_termios.c_cc[VTIME] = 0;

	cfmakeraw(&_termios);
	if( tcsetattr(fuart, TCSAFLUSH, &_termios) < 0){
		perror("tcsetattr: ");
		return -1;
	}
	
	return fuart;
}

int main(int argc, char **argv)
{
	if( argc < 2 ){
		perror("No input device");
		return -1;
	}

	int fuart = open(argv[1], O_RDWR);

	if( fuart == -1 ){
		printf("Cannot open input device: %s", argv[1]);
		return -1;
	}
	if( initUart(fuart) == -1 ){
		perror("initUart: ");
		return -1;
	}
	pthread_t th_id;
	if( pthread_create(&th_id, NULL, uartRecv, (void*) &fuart) == -1 ){
		perror("Thread create");
		return -1;
	}
	//pthread_join(th_id, NULL);
	
	for(;;){

	#if(!TC_AFTER_EVERY_BYTE)
		
		write(fuart, (void*) &tab1[0], sizeof(tab1) / sizeof(tab1[0])); sleep(2);
		write(fuart, (void*) &tab3[0], sizeof(tab3) / sizeof(tab3[0])); sleep(2);
		write(fuart, (void*) &tab2[0], sizeof(tab2) / sizeof(tab2[0])); sleep(2);
		write(fuart, (void*) &tab4[0], sizeof(tab4) / sizeof(tab4[0])); sleep(2);
		
	#else
		for(int i = 0; i < sizeof(tab1) / sizeof(tab1[0]); ++i){
			write(fuart, (void*) &tab1[i], sizeof(tab1[0])); usleep(10000);
		}
		sleep(2);
		
		for(int i = 0; i < sizeof(tab2) / sizeof(tab2[0]); ++i){
			write(fuart, (void*) &tab2[i], sizeof(tab2[0])); usleep(10000);
		}
		
		sleep(2);
		for(int i = 0; i < sizeof(tab3) / sizeof(tab3[0]); ++i){
			write(fuart, (void*) &tab3[i], sizeof(tab3[0])); usleep(10000);
		}
		
		sleep(2);
		for(int i = 0; i < sizeof(tab4) / sizeof(tab4[0]); ++i){
			write(fuart, (void*) &tab4[i], sizeof(tab4[0])); usleep(10000);
		}
		
	#endif
	}
	
	close(fuart);
return 0;
}
